<script lang="ts">
    import { Color } from "$lib/proxies/Color";
    import type { Farmer } from "$lib/proxies/Farmer";
    import { saveManager } from "$lib/save.svelte";
    import UiContainer from "$lib/ui/UIContainer.svelte";
    import { Gender } from "$types/save/1.6";
    import Preview from "./CharacterPreview.svelte";

    const textFields = [
        ["Name", "name"],
        ["Farm Name", "farmName"],
        ["Favorite Thing", "favoriteThing"],
    ] satisfies [string, keyof Farmer][];

    const colorFields = [
        ["Eye Color", "eyeColor"],
        ["Hair Color", "hairColor"],
    ] satisfies [string, keyof Farmer][];

    // Label, key, min, max
    const numberFields = [
        ["Skin", "skin", 0, 23],
        ["Hair", "hairstyle", 0, 72],
        ["Acc", "accessory", -1, 29],
    ] satisfies [string, keyof Farmer, number, number][];
    let player = saveManager.save?.player;
</script>

<UiContainer>
    {#if player}
        <div class="wrapper">
            <div class="editor1">
                <Preview {player} />
                <div class="selector">
                    <label>
                        ðŸš¹
                        <input
                            type="radio"
                            name="gender"
                            value="male"
                            checked={player && player.gender === Gender.Male}
                            onclick={() =>
                                player && (player.gender = Gender.Male)}
                        />
                    </label>
                    <label>
                        ðŸšº
                        <input
                            type="radio"
                            name="gender"
                            value="female"
                            checked={player && player.gender === Gender.Female}
                            onclick={() =>
                                player && (player.gender = Gender.Female)}
                        />
                    </label>
                </div>
                <div class="appearance">
                    {#each numberFields as [label, key, min, max]}
                        <label>
                            {label}
                            <input
                                type="number"
                                data-testid={`appearance-${key}`}
                                {min}
                                {max}
                                bind:value={player[key]}
                            />
                        </label>
                    {/each}
                </div>
            </div>
            <div class="editor2">
                {#each textFields as [label, key]}
                    <div>
                        <label>
                            <small>{label}</small>
                            <input
                                type="text"
                                data-testid={`appearance-${key}`}
                                bind:value={player[key]}
                            />
                        </label>
                    </div>
                {/each}
                {#each colorFields as [label, key]}
                    <div>
                        <label>
                            <small>{label}</small>
                            <div class="selector">
                                <input
                                    type="color"
                                    data-testid={`appearance-${key}`}
                                    value={player[key].toHex()}
                                    onchange={(e) => {
                                        player[key] = new Color(
                                            // @ts-expect-error
                                            e.target.value ?? "#0000FF",
                                        );
                                        // console.log(player[key].toHex());
                                    }}
                                />
                            </div>
                        </label>
                    </div>
                {/each}
            </div>
        </div>
    {/if}
</UiContainer>

<style>
    .wrapper {
        display: grid;
        grid-template-columns: 1fr 3fr;
        gap: 16px;
    }

    .editor1 {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
    }

    .editor2 label {
        display: grid;
        grid-template-columns: 1fr 3fr;
        align-items: center;
    }

    .editor2 > div {
        display: grid;
        grid-template-columns: 6fr 1fr;
        gap: 8px;
        width: 100%;
        align-items: center;
    }

    .editor2 {
        align-items: start;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    input {
        text-align: center;
    }

    .selector {
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

    .selector input {
        appearance: none;
    }

    .selector label {
        border-radius: 4px;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding-bottom: 0.1em;
        font-size: 1.5em;
        cursor: pointer;
        /* Beef up the text shadow a little bit, some emojis might blend into the bg too much */
        text-shadow: -0.05em 0.05em 0.1em rgba(0, 0, 0, 0.6);
    }

    .selector label:has(input:checked) {
        border: solid 3px #d93703;
    }

    .selector label:has(input:not(:checked)) {
        border: solid 3px #00000000;
    }

    .selector label input {
        position: absolute;
    }

    .appearance {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    .appearance label {
        display: flex;
        justify-content: space-between;
    }
</style>
